<h2>Ausgaben</h2>

<mat-tab-group animationDuration="200ms">
  <!-- Tab 1: Expense entries -->
  <mat-tab>
    <ng-template mat-tab-label>
      <span class="tab-label">
        <mat-icon>receipt</mat-icon>
        <span>Ausgaben</span>
      </span>
    </ng-template>

    <div class="tab-content">
      <!-- Running total -->
      <mat-card class="total-card">
        <mat-card-content>
          <div class="total-row">
            <span class="total-label">Gesamtausgaben</span>
            <span class="total-amount">{{ expenseTotal() | currency:'EUR':'symbol':'1.2-2':'de-DE' }}</span>
          </div>
          <div class="entry-count">{{ entries().length }} Einträge</div>
        </mat-card-content>
      </mat-card>

      <!-- Add button -->
      <div class="actions-bar">
        <button mat-raised-button color="primary" (click)="toggleExpenseForm()">
          <mat-icon>{{ showExpenseForm() ? 'close' : 'add' }}</mat-icon>
          {{ showExpenseForm() ? 'Abbrechen' : 'Neue Ausgabe' }}
        </button>
      </div>

      <!-- Entry form -->
      @if (showExpenseForm()) {
        <mat-card class="form-card">
          <mat-card-header>
            <mat-card-title>Neue Ausgabe</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="expenseForm" (ngSubmit)="onSubmitExpense()" class="entry-form">
              <mat-form-field appearance="outline">
                <mat-label>Betrag (EUR)</mat-label>
                <input matInput type="number" formControlName="amount" step="0.01" min="0.01">
                @if (expenseForm.get('amount')?.hasError('required')) {
                  <mat-error>Betrag ist erforderlich</mat-error>
                }
                @if (expenseForm.get('amount')?.hasError('min')) {
                  <mat-error>Betrag muss mindestens 0,01 EUR sein</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Kategorie</mat-label>
                <input matInput formControlName="category">
                @if (expenseForm.get('category')?.hasError('required')) {
                  <mat-error>Kategorie ist erforderlich</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Datum</mat-label>
                <input matInput [matDatepicker]="expPicker" formControlName="entryDate">
                <mat-datepicker-toggle matIconSuffix [for]="expPicker"></mat-datepicker-toggle>
                <mat-datepicker #expPicker></mat-datepicker>
                @if (expenseForm.get('entryDate')?.hasError('required')) {
                  <mat-error>Datum ist erforderlich</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Zuordnungsregel</mat-label>
                <mat-select formControlName="allocationRuleId">
                  <mat-option [value]="null">Keine</mat-option>
                  @for (rule of allocationRules(); track rule.id) {
                    <mat-option [value]="rule.id">
                      {{ rule.name }} ({{ rule.freiberufPct }}/{{ rule.gewerbePct }}/{{ rule.personalPct }})
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Beschreibung</mat-label>
                <input matInput formControlName="description">
              </mat-form-field>

              <div class="form-actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="expenseForm.invalid">
                  <mat-icon>save</mat-icon> Speichern
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      }

      <!-- Loading spinner -->
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      }

      <!-- Entries table -->
      @if (!loading() && entries().length > 0) {
        <table mat-table [dataSource]="entries()" class="entries-table">
          <ng-container matColumnDef="entryDate">
            <th mat-header-cell *matHeaderCellDef>Datum</th>
            <td mat-cell *matCellDef="let entry">{{ entry.entryDate | date:'dd.MM.yyyy':'':'de-DE' }}</td>
          </ng-container>

          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Kategorie</th>
            <td mat-cell *matCellDef="let entry">{{ entry.category }}</td>
          </ng-container>

          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef class="amount-col">Betrag</th>
            <td mat-cell *matCellDef="let entry" class="amount-col">
              {{ entry.amount | currency:'EUR':'symbol':'1.2-2':'de-DE' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="gwg">
            <th mat-header-cell *matHeaderCellDef>GWG</th>
            <td mat-cell *matCellDef="let entry">
              @if (entry.gwg) {
                <span class="gwg-badge" matTooltip="Geringwertiges Wirtschaftsgut (bis 800 EUR netto)">GWG</span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="allocationRule">
            <th mat-header-cell *matHeaderCellDef>Zuordnung</th>
            <td mat-cell *matCellDef="let entry">
              @if (entry.allocationRule) {
                <span class="rule-chip" matTooltip="{{ entry.allocationRule.freiberufPct }}% F / {{ entry.allocationRule.gewerbePct }}% G / {{ entry.allocationRule.personalPct }}% P">
                  {{ entry.allocationRule.name }}
                </span>
              } @else {
                <span class="no-rule">—</span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Beschreibung</th>
            <td mat-cell *matCellDef="let entry">{{ entry.description || '—' }}</td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let entry">
              <button mat-icon-button color="warn" (click)="deleteExpense(entry.id)" title="Löschen">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      }

      @if (!loading() && entries().length === 0) {
        <div class="empty-state">
          <mat-icon>inbox</mat-icon>
          <p>Noch keine Ausgaben vorhanden.</p>
        </div>
      }
    </div>
  </mat-tab>

  <!-- Tab 2: Allocation rules -->
  <mat-tab>
    <ng-template mat-tab-label>
      <span class="tab-label">
        <mat-icon>tune</mat-icon>
        <span>Zuordnung</span>
      </span>
    </ng-template>

    <div class="tab-content">
      <div class="actions-bar">
        <button mat-raised-button color="primary" (click)="toggleRuleForm()">
          <mat-icon>{{ showRuleForm() ? 'close' : 'add' }}</mat-icon>
          {{ showRuleForm() ? 'Abbrechen' : 'Neue Regel' }}
        </button>
      </div>

      @if (showRuleForm()) {
        <mat-card class="form-card">
          <mat-card-header>
            <mat-card-title>Neue Zuordnungsregel</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="ruleForm" (ngSubmit)="onSubmitRule()">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Regelname</mat-label>
                <input matInput formControlName="name" placeholder="z.B. Büro 60/30/10">
                @if (ruleForm.get('name')?.hasError('required')) {
                  <mat-error>Name ist erforderlich</mat-error>
                }
              </mat-form-field>

              <app-allocation-slider
                (allocationChange)="onAllocationChange($event)">
              </app-allocation-slider>

              <div class="form-actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="ruleForm.invalid">
                  <mat-icon>save</mat-icon> Speichern
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      }

      @if (allocationRules().length > 0) {
        <table mat-table [dataSource]="allocationRules()" class="entries-table">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let rule">{{ rule.name }}</td>
          </ng-container>

          <ng-container matColumnDef="freiberufPct">
            <th mat-header-cell *matHeaderCellDef class="pct-col">Freiberuf</th>
            <td mat-cell *matCellDef="let rule" class="pct-col freiberuf">{{ rule.freiberufPct }}%</td>
          </ng-container>

          <ng-container matColumnDef="gewerbePct">
            <th mat-header-cell *matHeaderCellDef class="pct-col">Gewerbe</th>
            <td mat-cell *matCellDef="let rule" class="pct-col gewerbe">{{ rule.gewerbePct }}%</td>
          </ng-container>

          <ng-container matColumnDef="personalPct">
            <th mat-header-cell *matHeaderCellDef class="pct-col">Personal</th>
            <td mat-cell *matCellDef="let rule" class="pct-col personal">{{ rule.personalPct }}%</td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let rule">
              <button mat-icon-button color="warn" (click)="deleteRule(rule.id)" title="Löschen">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="ruleDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: ruleDisplayedColumns;"></tr>
        </table>
      } @else {
        <div class="empty-state">
          <mat-icon>tune</mat-icon>
          <p>Noch keine Zuordnungsregeln vorhanden.</p>
        </div>
      }
    </div>
  </mat-tab>

  <!-- Tab 3: AfA schedule -->
  <mat-tab>
    <ng-template mat-tab-label>
      <span class="tab-label">
        <mat-icon>trending_down</mat-icon>
        <span>AfA</span>
      </span>
    </ng-template>

    <div class="tab-content">
      @if (nonGwgEntries().length > 0) {
        <p class="section-hint">Wählen Sie eine Ausgabe, um den AfA-Plan anzuzeigen:</p>
        <div class="afa-asset-list">
          @for (entry of nonGwgEntries(); track entry.id) {
            <button mat-stroked-button
                    [class.selected]="selectedExpenseForAfa()?.id === entry.id"
                    (click)="loadAfaSchedule(entry)">
              {{ entry.category }} — {{ entry.amount | currency:'EUR':'symbol':'1.2-2':'de-DE' }}
              ({{ entry.entryDate | date:'dd.MM.yyyy':'':'de-DE' }})
            </button>
          }
        </div>
      } @else {
        <div class="empty-state">
          <mat-icon>trending_down</mat-icon>
          <p>Keine abschreibungsfähigen Ausgaben vorhanden (nur Ausgaben über 800 EUR).</p>
        </div>
      }

      @if (afaLoading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      }

      @if (selectedExpenseForAfa() && afaSchedule().length > 0 && !afaLoading()) {
        <app-afa-schedule [schedule]="afaSchedule()" [assetName]="selectedExpenseForAfa()!.category">
        </app-afa-schedule>
      }
    </div>
  </mat-tab>

  <!-- Tab 4: Home office calculator -->
  <mat-tab>
    <ng-template mat-tab-label>
      <span class="tab-label">
        <mat-icon>home_work</mat-icon>
        <span>Homeoffice</span>
      </span>
    </ng-template>

    <div class="tab-content">
      <app-home-office-calculator></app-home-office-calculator>
    </div>
  </mat-tab>
</mat-tab-group>
