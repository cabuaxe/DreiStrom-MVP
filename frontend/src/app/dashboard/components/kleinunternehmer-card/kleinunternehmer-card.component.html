@if (loading() && !status()) {
  <mat-card>
    <mat-card-content class="loading-state">
      <mat-icon>hourglass_empty</mat-icon>
      <span>Lade Kleinunternehmer-Status…</span>
    </mat-card-content>
  </mat-card>
} @else if (status(); as s) {
  <mat-card [class.warning]="hasWarning()" [class.safe]="!hasWarning()">
    <mat-card-header>
      <mat-icon mat-card-avatar class="card-icon" [class.warning-icon]="hasWarning()">
        {{ hasWarning() ? 'warning' : 'verified' }}
      </mat-icon>
      <mat-card-title>Kleinunternehmer §19 UStG</mat-card-title>
      <mat-card-subtitle>Steuerjahr {{ s.year }}</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Current year revenue -->
      <div class="threshold-section">
        <div class="threshold-header">
          <span class="threshold-label">Ist-Umsatz</span>
          <span class="threshold-amount" [class.exceeded]="s.currentExceeded">
            {{ s.currentRevenue | currency:'EUR':'symbol':'1.2-2':'de-DE' }}
          </span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="currentBarValue()"
          [color]="s.currentExceeded ? 'warn' : 'primary'">
        </mat-progress-bar>
        <div class="threshold-limits">
          <span>0 €</span>
          <span class="limit-marker">Grenze: {{ s.currentYearLimit | currency:'EUR':'symbol':'1.0-0':'de-DE' }}</span>
        </div>
      </div>

      <!-- Projected annual revenue -->
      <div class="threshold-section">
        <div class="threshold-header">
          <span class="threshold-label">Hochrechnung Jahresende</span>
          <span class="threshold-amount" [class.exceeded]="s.projectedExceeded">
            {{ s.projectedRevenue | currency:'EUR':'symbol':'1.2-2':'de-DE' }}
          </span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="projectedBarValue()"
          [color]="s.projectedExceeded ? 'warn' : 'accent'">
        </mat-progress-bar>
        <div class="threshold-limits">
          <span>0 €</span>
          <span class="limit-marker">Grenze: {{ s.projectedYearLimit | currency:'EUR':'symbol':'1.0-0':'de-DE' }}</span>
        </div>
      </div>

      <!-- Status indicator -->
      <div class="status-row" [class.exceeded]="hasWarning()">
        <mat-icon>{{ hasWarning() ? 'cancel' : 'check_circle' }}</mat-icon>
        <span>
          @if (hasWarning()) {
            Kleinunternehmerregelung gefährdet
          } @else {
            Kleinunternehmerregelung anwendbar
          }
        </span>
      </div>
    </mat-card-content>
  </mat-card>
}
