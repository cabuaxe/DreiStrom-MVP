@if (loading() && !status()) {
  <mat-card>
    <mat-card-content class="loading-state">
      <mat-icon>hourglass_empty</mat-icon>
      <span>Lade Gewerbesteuer-Status…</span>
    </mat-card-content>
  </mat-card>
} @else if (status(); as s) {
  <mat-card [class.warning]="hasAnyWarning()" [class.safe]="!hasAnyWarning()">
    <mat-card-header>
      <mat-icon mat-card-avatar class="card-icon" [class.warning-icon]="hasAnyWarning()">
        {{ hasAnyWarning() ? 'warning' : 'account_balance' }}
      </mat-icon>
      <mat-card-title>Gewerbesteuer</mat-card-title>
      <mat-card-subtitle>Freibetrag & Bilanzierung — {{ s.year }}</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Freibetrag section -->
      <div class="threshold-section">
        <div class="threshold-header">
          <span class="threshold-label">GewSt-Freibetrag</span>
          <span class="threshold-values">
            {{ s.gewerbeProfit | currency:'EUR':'symbol':'1.0-0':'de-DE' }}
            / {{ s.freibetrag | currency:'EUR':'symbol':'1.0-0':'de-DE' }}
          </span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="freibetragProgress()"
          [color]="s.freibetragExceeded ? 'warn' : 'primary'">
        </mat-progress-bar>
        <div class="threshold-status">
          <mat-icon [class.exceeded]="s.freibetragExceeded">
            {{ s.freibetragExceeded ? 'cancel' : 'check_circle' }}
          </mat-icon>
          <span>
            @if (s.freibetragExceeded) {
              Freibetrag überschritten — Gewerbesteuer fällt an
            } @else {
              Innerhalb des Freibetrags (24.500 €)
            }
          </span>
        </div>
      </div>

      <!-- Bilanzierung Revenue threshold -->
      <div class="threshold-section">
        <div class="threshold-header">
          <span class="threshold-label">Bilanzierungspflicht (Umsatz)</span>
          <span class="threshold-values">
            {{ s.gewerbeRevenue | currency:'EUR':'symbol':'1.0-0':'de-DE' }}
            / {{ s.bilanzierungRevenueThreshold | currency:'EUR':'symbol':'1.0-0':'de-DE' }}
          </span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="revenueProgress()"
          [color]="s.bilanzierungRevenueExceeded ? 'warn' : 'primary'">
        </mat-progress-bar>
        <div class="threshold-status">
          <mat-icon [class.exceeded]="s.bilanzierungRevenueExceeded">
            {{ s.bilanzierungRevenueExceeded ? 'cancel' : 'check_circle' }}
          </mat-icon>
          <span>
            @if (s.bilanzierungRevenueExceeded) {
              Umsatzschwelle überschritten — Bilanzierungspflicht
            } @else {
              Unter der Umsatzschwelle ({{ s.bilanzierungRevenueThreshold | currency:'EUR':'symbol':'1.0-0':'de-DE' }})
            }
          </span>
        </div>
      </div>

      <!-- Bilanzierung Profit threshold -->
      <div class="threshold-section">
        <div class="threshold-header">
          <span class="threshold-label">Bilanzierungspflicht (Gewinn)</span>
          <span class="threshold-values">
            {{ s.gewerbeProfit | currency:'EUR':'symbol':'1.0-0':'de-DE' }}
            / {{ s.bilanzierungProfitThreshold | currency:'EUR':'symbol':'1.0-0':'de-DE' }}
          </span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="s.bilanzierungProfitExceeded ? 100 : (s.gewerbeProfit / s.bilanzierungProfitThreshold) * 100"
          [color]="s.bilanzierungProfitExceeded ? 'warn' : 'primary'">
        </mat-progress-bar>
        <div class="threshold-status">
          <mat-icon [class.exceeded]="s.bilanzierungProfitExceeded">
            {{ s.bilanzierungProfitExceeded ? 'cancel' : 'check_circle' }}
          </mat-icon>
          <span>
            @if (s.bilanzierungProfitExceeded) {
              Gewinnschwelle überschritten — Bilanzierungspflicht
            } @else {
              Unter der Gewinnschwelle ({{ s.bilanzierungProfitThreshold | currency:'EUR':'symbol':'1.0-0':'de-DE' }})
            }
          </span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
}
