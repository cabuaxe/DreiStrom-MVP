<mat-card>
  <mat-card-header>
    <mat-card-title>Umsatzsteuervoranmeldung</mat-card-title>
    <mat-card-subtitle>USt-VA Übersicht</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="toolbar">
      <mat-form-field appearance="outline" class="year-select">
        <mat-label>Jahr</mat-label>
        <mat-select [value]="selectedYear()" (selectionChange)="onYearChange($event.value)">
          @for (year of yearOptions; track year) {
            <mat-option [value]="year">{{ year }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    @if (loading()) {
      <p class="loading-text">Lade Voranmeldungen…</p>
    } @else if (returns().length === 0) {
      <p class="empty-text">Keine Voranmeldungen für {{ selectedYear() }} vorhanden.</p>
    } @else {
      <table mat-table [dataSource]="returns()" class="vat-table">

        <ng-container matColumnDef="period">
          <th mat-header-cell *matHeaderCellDef>Zeitraum</th>
          <td mat-cell *matCellDef="let vr">{{ formatPeriod(vr) }}</td>
        </ng-container>

        <ng-container matColumnDef="outputVat">
          <th mat-header-cell *matHeaderCellDef class="right">USt</th>
          <td mat-cell *matCellDef="let vr" class="right">
            {{ vr.outputVat | currency:'EUR':'symbol':'1.2-2':'de-DE' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="inputVat">
          <th mat-header-cell *matHeaderCellDef class="right">Vorsteuer</th>
          <td mat-cell *matCellDef="let vr" class="right">
            {{ vr.inputVat | currency:'EUR':'symbol':'1.2-2':'de-DE' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="netPayable">
          <th mat-header-cell *matHeaderCellDef class="right">Zahllast</th>
          <td mat-cell *matCellDef="let vr" class="right amount"
              [class.negative]="vr.netPayable < 0">
            {{ vr.netPayable | currency:'EUR':'symbol':'1.2-2':'de-DE' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let vr">
            <mat-chip [highlighted]="vr.status !== 'DRAFT'">
              {{ statusLabel(vr.status) }}
            </mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let vr">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              @if (vr.status === 'DRAFT') {
                <button mat-menu-item (click)="onSubmit(vr)">
                  <mat-icon>send</mat-icon>
                  <span>Abgeben</span>
                </button>
              }
              <button mat-menu-item (click)="onExportXml(vr)">
                <mat-icon>code</mat-icon>
                <span>ELSTER XML</span>
              </button>
              <button mat-menu-item (click)="onExportCsv(vr)">
                <mat-icon>table_chart</mat-icon>
                <span>CSV Export</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    }
  </mat-card-content>
</mat-card>
