<div class="decision-panel">
  <h4>
    <mat-icon class="question-icon">help_outline</mat-icon>
    {{ decisionPoint().question }}
  </h4>

  @if (decisionPoint().userChoice) {
    <div class="decision-made">
      <mat-icon>check_circle</mat-icon>
      <span>
        Entscheidung getroffen:
        <strong>{{ decisionPoint().userChoice === 'OPTION_A' ? decisionPoint().optionA : decisionPoint().optionB }}</strong>
      </span>
    </div>
  } @else {
    <div class="options-grid">
      <mat-card class="option-card"
                [class.recommended]="decisionPoint().recommendation === 'OPTION_A'">
        @if (decisionPoint().recommendation === 'OPTION_A') {
          <mat-chip class="recommendation-chip">Empfohlen</mat-chip>
        }
        <mat-card-header>
          <mat-card-title>Kleinunternehmerregelung</mat-card-title>
          <mat-card-subtitle>§19 UStG</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>{{ decisionPoint().optionA }}</p>

          @if (evaluation(); as eval) {
            <mat-divider />
            <ul class="pros">
              @for (pro of eval.prosKleinunternehmer; track pro) {
                <li><mat-icon class="pro-icon">add_circle</mat-icon> {{ pro }}</li>
              }
            </ul>
            <ul class="cons">
              @for (con of eval.consKleinunternehmer; track con) {
                <li><mat-icon class="con-icon">remove_circle</mat-icon> {{ con }}</li>
              }
            </ul>
          }
        </mat-card-content>
        <mat-card-actions>
          <button mat-flat-button (click)="selectOption('OPTION_A')">
            Kleinunternehmer wählen
          </button>
        </mat-card-actions>
      </mat-card>

      <mat-card class="option-card"
                [class.recommended]="decisionPoint().recommendation === 'OPTION_B'">
        @if (decisionPoint().recommendation === 'OPTION_B') {
          <mat-chip class="recommendation-chip">Empfohlen</mat-chip>
        }
        <mat-card-header>
          <mat-card-title>Regelbesteuerung</mat-card-title>
          <mat-card-subtitle>Standard-USt</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>{{ decisionPoint().optionB }}</p>

          @if (evaluation(); as eval) {
            <mat-divider />
            <ul class="pros">
              @for (pro of eval.prosRegelbesteuerung; track pro) {
                <li><mat-icon class="pro-icon">add_circle</mat-icon> {{ pro }}</li>
              }
            </ul>
            <ul class="cons">
              @for (con of eval.consRegelbesteuerung; track con) {
                <li><mat-icon class="con-icon">remove_circle</mat-icon> {{ con }}</li>
              }
            </ul>
          }
        </mat-card-content>
        <mat-card-actions>
          <button mat-flat-button (click)="selectOption('OPTION_B')">
            Regelbesteuerung wählen
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    @if (evaluation(); as eval) {
      <div class="evaluation-summary">
        <h5>Analyse</h5>
        <p>{{ eval.summary }}</p>
        <div class="eval-metrics">
          <span>Voraussichtlicher Umsatz: {{ eval.projectedTotalRevenue | currency:'EUR':'symbol':'1.0-0':'de-DE' }}</span>
          <span>Vorsteuer-Ersparnis: {{ eval.estimatedVorsteuerSavings | currency:'EUR':'symbol':'1.0-0':'de-DE' }}/Jahr</span>
          <span>B2B-Anteil: {{ eval.b2bRatio | number:'1.0-0':'de-DE' }} %</span>
        </div>
      </div>
    } @else {
      <div class="evaluate-action">
        <button mat-stroked-button (click)="loadEvaluation()" [disabled]="evaluating()">
          @if (evaluating()) {
            <mat-spinner diameter="18" />
          } @else {
            <mat-icon>analytics</mat-icon>
          }
          Empfehlung berechnen
        </button>
        <span class="evaluate-hint">Analysiert Ihre aktuellen Geschäftsdaten</span>
      </div>
    }
  }

  @if (decisionPoint().recommendationReason) {
    <p class="recommendation-reason">
      <mat-icon>info</mat-icon>
      {{ decisionPoint().recommendationReason }}
    </p>
  }
</div>
