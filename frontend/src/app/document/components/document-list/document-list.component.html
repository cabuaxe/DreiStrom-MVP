<mat-card>
  <mat-card-header>
    <mat-icon mat-card-avatar class="card-icon">folder</mat-icon>
    <mat-card-title>Dokumentenarchiv</mat-card-title>
    <mat-card-subtitle>GoBD-konform — §147 AO Aufbewahrungsfristen</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="toolbar">
      <mat-form-field appearance="outline" class="type-filter">
        <mat-label>Kategorie</mat-label>
        <mat-select [value]="filterType()" (selectionChange)="onFilterChange($event.value)">
          @for (opt of typeOptions; track opt.value) {
            <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    @if (loading()) {
      <p class="loading-text">Lade Dokumente…</p>
    } @else if (documents().length === 0) {
      <div class="empty-state">
        <mat-icon>folder_open</mat-icon>
        <p>Keine Dokumente vorhanden.</p>
      </div>
    } @else {
      <table mat-table [dataSource]="documents()" class="doc-table">

        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Typ</th>
          <td mat-cell *matCellDef="let doc">
            <mat-chip-set>
              <mat-chip>{{ typeLabel(doc.documentType) }}</mat-chip>
            </mat-chip-set>
          </td>
        </ng-container>

        <ng-container matColumnDef="fileName">
          <th mat-header-cell *matHeaderCellDef>Datei</th>
          <td mat-cell *matCellDef="let doc">
            <span class="file-name">{{ doc.fileName }}</span>
            @if (doc.description) {
              <span class="file-desc">{{ doc.description }}</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="size">
          <th mat-header-cell *matHeaderCellDef class="right">Größe</th>
          <td mat-cell *matCellDef="let doc" class="right">
            {{ formatFileSize(doc.fileSize) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="retention">
          <th mat-header-cell *matHeaderCellDef>Aufbewahrung</th>
          <td mat-cell *matCellDef="let doc">
            <span class="retention" [class.locked]="doc.deletionLocked">
              <mat-icon class="retention-icon">
                {{ doc.deletionLocked ? 'lock' : 'lock_open' }}
              </mat-icon>
              {{ retentionLabel(doc) }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="uploadedAt">
          <th mat-header-cell *matHeaderCellDef>Hochgeladen</th>
          <td mat-cell *matCellDef="let doc">
            {{ doc.uploadedAt | date:'dd.MM.yyyy' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let doc">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="onDownload(doc)">
                <mat-icon>download</mat-icon>
                <span>Herunterladen</span>
              </button>
              <button mat-menu-item
                      [disabled]="doc.deletionLocked"
                      (click)="onDelete(doc)"
                      [matTooltip]="doc.deletionLocked ? 'Aufbewahrungsfrist läuft noch' : ''">
                <mat-icon>delete</mat-icon>
                <span>Löschen</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    }
  </mat-card-content>
</mat-card>
